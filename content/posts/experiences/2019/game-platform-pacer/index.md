---
title: "棋牌遊戲開發| PVE伺服器篇"
date: 2020-01-26T00:00:00+08:00
hero: /posts/experiences/2019/game-platform-pacer/image/banner.jpeg
description: "本篇內容為棋牌類型為主的網頁遊戲 PVE 伺服器架構心得筆記，涉及遊戲單元、狀態機與機器人等。"
menu:
  sidebar:
    name: "棋牌遊戲開發| PVE伺服器篇"
    identifier: 58poker-pacer
    parent: "experiences-2019"
    weight: 20200126001
---

---

### 前言

在系列文的第二篇 [棋牌遊戲開發| 遊戲伺服器篇](./../game-platform-backend/) 中我們談完了遊戲伺服器的系統架構，本篇要進一步探討其中的 PVE 部分。

由於每間公司在業務邏輯上有各自不同的決策，因此本篇重點將會著重在模組的設計，較少提及其延伸應用。

---

### PVE 伺服器系統架構圖

{{< img src="/posts/experiences/2019/game-platform-pacer/image/mindmap.svg" align="center" >}}

PVE 伺服器的佈署環境與前篇的遊戲伺服器相同，因此在這邊就不再多加贅述。

#### 常駐服務

  - 當系統發生未知異常導致崩潰後，藉由 Linux Supervisor 我們能在最短時間內重啟並從 Redis 中載入歷史快照紀錄還原崩潰之前的狀態，大幅降低對客戶端造成的影響。
  - 監控所有已建立的 Bot 執行緒，透過定期心跳檢測確認當前的活躍狀況與發生未知異常時的處理機制。

#### 核心單元業務

  - 與其他服務傳輸時的資料正規化。
  - 維護所有 已存在與準備建立/銷毀 的牌桌區塊。
  - 維護所有 已存在與準備建立/銷毀 的 Bot 執行緒。

#### 網路單元業務

  - 維護與其他在 Consul 上已註冊服務溝通時的擴充功能。
  - 維護與 Redis 溝通時的擴充功能。

#### 邏輯單元業務

  - 根據每款遊戲不同的遊戲規則有不同的處理機制。
  - 負責模擬不同玩家心態所量化成的遊戲策略方式。
  - 負責處理當遊戲複雜度高於一定難度時能夠快速解析當前局勢的演算法。

---

### 跨服務溝通介紹

{{< img src="https://imgur.com/rtSqnuy.png" align="center" >}}

 - 不同服務 (即遊戲伺服器與 PVE 伺服器) 之間透過 NATS 進行溝通。
 - 每款遊戲在 Packet Office 內表示為一個獨立的遊戲單元。
 - 遊戲單元與 Bot 之間透過 Channel 共享資料。
 - 接收封包時，遊戲單元與 Bot 對應關係為一對一，即每次收到的封包只會放進指定的 Bot Channel 內。
 - 發送封包時，遊戲單元與 Bot 對應關係為一對多，即相同牌桌內的 Bot Channel 是互相共享的，用以減輕遊戲單元在封裝封包時的複雜度。

簡單來說，我們可以把 Packet Office 想成郵局，每個遊戲單元都是郵局內的其中一個窗口，當有民眾進入 (收到封包) 時，會在門口先抽取號碼牌後，等待系統引導到指定的窗口辦理業務。窗口負責人在收到業務後，會根據上面的備註進行分類，從而將包裹轉交到指定的目的地 (Bot 執行緒)。

同時，上述所有在窗口處理的業務都會被寫入 Redis 進行備份，如此一來在發生不可預期的錯誤而被重啟時，能夠盡可能的牌局狀況回復到離崩潰最近的時間點，減少因為重啟時在客戶端所造成的影響。

---

### PVE 伺服器工作流程

{{< img src="https://imgur.com/tyDuGwh.png" align="center" >}}

該圖為 PVE 伺服器在進行一局遊戲時的完整時序圖。

  - 為了降低傳輸成本，所有寫入至 Redis 的資料都只針對有被變更過的資料。
  - 所有的請求在從佇列取出後都是使用 goroutine 進行異步處理，若遇到 Bot 的連續動作時，則會在 Bot 執行緒中自行進行同步處理。若同步需求涉及兩隻以上的 Bot，則會在 Packet Office 送出請求前進行等待。
  - 在 Bot 正常結束遊戲後，會先至 Redis 刪除關於這隻 Bot 所有歷史快照後才結束執行緒。為了避免有意外發生，每隻 Bot 在 Redis 上所對應到的 Key 皆有一定的生命週期防止資料溢出或產生衝突。