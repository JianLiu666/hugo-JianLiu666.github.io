---
title: "棋牌遊戲開發| 遊戲伺服器篇"
date: 2020-01-25T00:00:00+08:00
hero: /posts/experiences/2019/game-platform-backend/image/banner.jpeg
description: "本篇內容為棋牌類型為主的遊戲伺服器架構心得筆記，涉及高併發、玩家佇列與自動佈署等。"
menu:
  sidebar:
    name: "棋牌遊戲開發| 遊戲伺服器篇"
    identifier: 58poker-backend
    parent: "experiences-2019"
    weight: 20200125001
---

---

### 前言

在系列文的第一篇 棋牌遊戲開發| 前端篇 中我們完整介紹了個遊戲前端的技術框架，接下來就要開始進入到後端的範疇了。  

由於遊戲後端涵蓋許多服務，包含玩家匹配、遊戲邏輯、PVE 系統等。本篇會先盡可能地將所有的服務都逐一提過，後續在針對其中的某些項目做進一步的介紹。  

另外，遊戲伺服器的僅負責所有與遊戲流程相關的業務需求；換句話說，玩家在牌桌結束後產生的對應需求 (e.g. 籌碼流動、點數轉移等)，均不在此處理。

---

### 遊戲後端技術框架結構圖

{{< img src="/posts/experiences/2019/game-platform-backend/image/mindmap.svg" align="center" >}}

#### 資料庫選擇

  - MySQL：所有需要被永久保存的資料會在條件觸發後才進行寫入 (e.g. 牌局結算後)，減少在操作上的交換時間。
  - Redis：儲存需要在所有內部結點上共享的資料 (e.g. 玩家、牌局資料等)，以及需要 Real-time 支持的業務需求 (e.g. 正在進行遊戲中的牌局)。

#### 通訊方式選擇

  - TCP：與外部服務 (e.g. Consul、NATS、API等) 採用短連接方式進行資料交換。
  - WebSocket/MQTT：透過 WebSocket 與遊戲前端建立連線後使用 MQTT 作為通訊格式。
  - RPC：內部結點 (e.g. GameServer、PacerServer、Gateway) 溝通時的通訊方式。

#### 核心單元說明

   - 遊戲邏輯模組：能夠支援多種類型的通用遊戲開發模組 (e.g. 對弈/即時多人策略等類型)，且能因應遊戲規則細節進行擴充。
   - 機器人模組：適用於多種場合的 PVE 模組。
   - 牌桌模組：替客戶端提供幀同步與牌局主持的狀態機模組。
   - 玩家模組：將客戶端資料封裝成能夠因應不同遊戲任意擴充的彈性模組。

---

### 遊戲伺服器系統架構圖


{{< img src="https://imgur.com/W64gjHR.png" align="center" >}}

整個後端系統主要分為三大區塊，每個區塊都能夠視業務需要導入自動擴容，實現負載平衡、熱更新等功能。

  - Gateway：用於與客戶端建立長連接、心跳檢測與配發牌桌等功能。採用 WebSocket 與客戶端建立連線、透過 MQTT 通訊格式發送/接收訊息。
  - Game Server：建立牌桌模組提供給玩家加入，對已存在的牌桌管理生命週期。
  - Pacer Server：依牌桌需求建立機器人。

每個區塊內的服務在啟動後會向 Consul 進行註冊，相同區塊內的服務透過 Redis 同步資料，不同區塊之間使用 NATS 進行遠端調用與傳遞資料。

最後，所有牌桌在結束後會將牌局資料進行封裝後透過 API 轉交給專門負責交易/會員業務的系統進行處理。

---

### 遊戲伺服器工作流程

{{< img src="https://imgur.com/a8pnraP.png" align="center" >}}

該圖為後端伺服器在進行一局遊戲時的時序圖，內容著重在建立牌局時與前端、內部節點溝通的過程。

 - Client 與 Gateway 使用 Bearer Token 驗證。
 - 玩家在請求開始遊戲後，會進入到 Gateway 中的配對池等待配桌，匹配規則依業務需求而定。
 - 匹配過程包含建立匹配玩家清單、牌桌初始化、建立 Bot 執行緒 (視 PVP 或 PVE 而定) 與確認玩家就緒等動作。
 - 所有動作執行時都會將資料同步至 Redis 上，當系統發生未知原因導致崩潰後可以還原到當前狀態。